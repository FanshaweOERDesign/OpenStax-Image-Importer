<!DOCTYPE html>
<html>

<head>
    <title>OpenStax Image Importer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--[if lt IE 9]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    <link rel="shortcut icon" href="images/oer_logo.ico" />
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            background-image: url(images/fanshawe_wallpaper.jpg);
            position: relative;
        }

        #wrap {
            text-align: center;
            max-width: 600px;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1em;
            margin-top: 5vh;
        }

        body,
        div {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #logo {
            width: 74px;
        }

        #logo-div {
            text-align: center;
            margin-top: 2vh;
        }

        footer {
            text-align: center;
            color: #fff;
            margin-top: 1rem;
        }

        footer a {
            color: white;
        }

        #help-modal {
            display: none;
            position: fixed;
            top: 10em;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 60%;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            z-index: 1000;
            padding: 20px;
            border: 2px double black;

            h2 {
                text-align: center;
            }

            button {
                margin-top: 1.5rem;
                margin-left: 50%;
                transform: translateX(-50%);
                padding: 0.7rem 1.5rem;
                background: #0074d9;
                color: #fff;
                border: none;
                border-radius: 4px;
                font-size: 1rem;
                cursor: pointer;
                transition: background 0.2s;
            }
        }
    </style>
</head>

<body>
    <div id="wrap">
        <h1>Import OpenStax Images to Pressbooks</h1>
        <div>
            <input type="text" style="width: 100%; max-width: 600px;" id="openstax-url"
                placeholder="Enter OpenStax URL here (optional)" maxlength="200" />
            <input type="text" style="width: 100%; max-width: 600px;" id="sample-image-url"
                placeholder="Paste sample image URL from your Pressbook" maxlength="200" />
            <textarea id="htmlContent" rows="10" cols="50" placeholder="Paste your page HTML here..." maxlength="100000"></textarea>

            <button id="downloadZip">Process Images</button>
            <div id="status" style="display: none; font-weight: bold;">Processing...</div>
            <textarea id="output" rows="10" cols="50" style="display: none;"
                placeholder="Processed output will appear here..."></textarea>
            <button id="copyBtn" style="display: none;">Copy Output</button>
            <a id="help-link" href="#"
                onclick="document.getElementById('help-modal').style.display='block'; return false;"
                style="color: #0074d9; text-decoration: underline;">How to use this app</a>
        </div>
    </div>
    <div id="logo-div">
        <img id="logo" src="images/oer_logo.png" />
    </div>
    <footer>
        <div>OpenStax Image Importer by Jason Benoit and the Fanshawe OER Design Studio is
            open source software made available under the <a href="https://choosealicense.com/licenses/mit/">MIT
                License</a>.</div>
    </footer>
    <div id="help-modal">
        <h2>How to Use</h2>
        <p>This app assumes that the input provided is Pressbooks page HTML that has been imported from OpenStax using
            the OpenStax to Pressbooks XML app. To use this app:</p>
        <ol>
            <li>Paste the URL for the source OpenStax book. This will be used to supply backlinks in the image
                attribution. If you do not supply a URL, no backlinks will be created.</li>
            <li>Enter a sample image URL from your Pressbook. This can be the URL of any image already added to the
                Media Library of your Pressbook, and is required for the app to process the images imported from
                OpenStax so
                that they will display on your generated Pressbooks pages.</li>
            <li>Paste in the page HTML from Pressbooks</li>
            <li>Click the download button. A zip archive entitled <em>images</em> will download. This archive contains
                the imported images.</li>
            <li>Upload the images to your Pressbook Media Library. This can be done quickly by selecting all of the
                contents of the downloaded images folder and dragging the contents into the Media Library file uploader.
            </li>
            <li>Paste the generated HTML into the appropriate location in your Pressbook.</li>
        </ol>
        <button id="close-help"
            onclick="document.getElementById('help-modal').style.display='none'; return false;">Close</button>
    </div>
    <script src="./purify.min.js"></script>
    <script>
        // this both creates a zip file from the images and edits the HTML to replace 
        // the image URLs with the new Pressbooks URLs
        function $(id) {
            return document.getElementById(id);
        }

        function clientSideLimits(input, maxLength = 1000) {
        return input
            .slice(0, maxLength)
            .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ''); // Remove problematic chars
    }

        async function fetchOpenStaxTitle(url) {
            if (!url) return '';
            try {
                const response = await fetch(`/openstax-title?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                const data = await response.json();
                return data.title || '';
            } catch (err) {
                console.error('Error fetching OpenStax title:', err);
                return '';
            }
        }

        function getImageFilename(url) {
            return url.split('/').pop().split('.')[0] + (url.includes('webp') ? '.jpg' : url.substring(url.lastIndexOf('.')));
        }

        async function fetchAsBlob(url) {
            const proxyUrl = `/proxy-image?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            const blob = await response.blob();

            // convert to JPG if WEBP
            if (blob.type === 'image/webp') {
                const img = new Image();
                img.crossOrigin = 'anonymous';

                // Wait for the image to load before drawing to canvas
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = URL.createObjectURL(blob);
                });

                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;  // Use naturalWidth/naturalHeight
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const jpgBlob = await new Promise(resolve =>
                    canvas.toBlob(resolve, 'image/jpeg', 0.9)
                );

                // Clean up the object URL
                URL.revokeObjectURL(img.src);

                return jpgBlob;
            }
            return blob;
        }

        async function createZipFromImages(urls) {
            const zip = new JSZip();

            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                try {
                    const blob = await fetchAsBlob(url);
                    let imageFileName = getImageFilename(url);

                    zip.file(imageFileName, blob);
                } catch (err) {
                    console.error(`Error fetching image ${i + 1}:`, err);
                }
            }

            const zipBlob = await zip.generateAsync({ type: 'blob' });
            saveAs(zipBlob, 'images.zip');
        }

        function serializeAttributes(el) {
            const attrs = Array.from(el.attributes).map(attr =>
                `${attr.name}="${attr.value}"`
            );
            return attrs.length ? ' ' + attrs.join(' ') : '';
        }

        function getOwnFormattedText(node) {
            const allowedInlineTags = ['STRONG', 'EM', 'U', 'SPAN', 'CODE', 'SMALL', 'SUB', 'SUP', 'B', 'I'];

            let html = '';

            for (const child of Array.from(node.childNodes)) {
                if (child.nodeType === Node.TEXT_NODE) {
                    html += child.textContent;
                    child.remove();
                } else if (
                    child.nodeType === Node.ELEMENT_NODE &&
                    allowedInlineTags.includes(child.tagName)
                ) {
                    const inner = getOwnFormattedText(child);
                    html += `<${child.tagName.toLowerCase()}${serializeAttributes(child)}>${inner}</${child.tagName.toLowerCase()}>`;
                    child.remove();
                }
            }

            return html.trim();
        }

        function extractBookId(url) {
            const match = url.match(/\/sites\/(\d+)\//);
            return match ? match[1] : null;
        }

        function removeExistingCredit(caption) {
            let closeBracketIdx = caption.lastIndexOf(')');
            if (caption.length - closeBracketIdx > 2) {
                return caption;
            }
            let openBracketIdx = closeBracketIdx - 1;
            const bracketStack = [];
            bracketStack.push(')');
            while (openBracketIdx >= 0) {
                if (caption[openBracketIdx] === '(') {
                    bracketStack.pop();
                    if (bracketStack.length === 0) {
                        break;
                    }
                } else if (caption[openBracketIdx] === ')') {
                    bracketStack.push(')');
                }
                openBracketIdx--;
            }
            if (bracketStack.length === 0) {
                return caption.slice(0, openBracketIdx);
            }
            return caption;
        }

        function clientSideLimits(input, maxLength = 1000) {
            return input
                .slice(0, maxLength)
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ''); // Remove problematic chars
        }

        $('downloadZip').addEventListener('click', async () => {
            const rawHTML = DOMPurfify.sanitize(clientSideLimits($('htmlContent').value), 100000);
            const output = $('output');
            output.style.display = 'none';
            $('copyBtn').style.display = 'none';
            $('status').style.display = 'block';
            const sampleImageUrl = clientSideLimits($('sample-image-url').value.trim());
            const openStaxUrl = clientSideLimits($('openstax-url').value.trim());
            let openStaxTitle = '';
            if (openStaxUrl) {
                openStaxTitle = await fetchOpenStaxTitle(openStaxUrl);
                if (!openStaxTitle) {
                    openStaxTitle = openStaxUrl.slice(openStaxUrl.lastIndexOf('/') + 1).replace(/-/g, ' ')
                }
            }


            if (!rawHTML) {
                alert('Please paste your page HTML into the textarea.');
                return;
            }
            if (!sampleImageUrl) {
                alert('Please provide a sample image URL.');
                return;
            }
            const bookId = extractBookId(sampleImageUrl);
            if (!bookId) {
                alert('Invalid sample image URL. Please ensure it contains a valid book ID.');
                return;
            }
            const doc = new DOMParser().parseFromString(rawHTML, 'text/html');
            const imageContainers = doc.querySelectorAll('.wp-caption');
            const imageUrls = Array.from(imageContainers).map(figure => {
                const img = figure.querySelector('figure img');
                return img ? img.src : null;
            }).filter(url => url !== null);

            createZipFromImages(imageUrls);

            imageContainers.forEach((figure, index) => {
                const img = figure.querySelector('figure img');
                const openStaxSrc = img.src?.includes('openstax.org') ? img.src : '';
                const now = new Date();

                const uploadFolder = `https://ecampusontario.pressbooks.pub/app/uploads/sites/${bookId}/${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/`;
                if (img) {
                    const newSrc = `${uploadFolder}${getImageFilename(img.src)}`;
                    img.src = newSrc;
                }
                const existingCaption = getOwnFormattedText(figure);
                const figureCaption = figure.querySelector('figcaption');
                if (figureCaption) {
                    figureCaption.innerHTML = existingCaption + ' ' + (openStaxSrc && openStaxUrl ? (`<a href="${openStaxSrc}" target="_blank">Image</a> from <a href="${openStaxUrl}" target="_blank">${openStaxTitle}</a>, <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0</a>`) : '');
                } else {
                    const newCaption = doc.createElement('figcaption');
                    if (openStaxSrc && openStaxUrl) {

                        newCaption.innerHTML = existingCaption + ' ' + `<a href="${openStaxSrc}" target="_blank">Image</a> from <a href="${openStaxUrl}" target="_blank">${openStaxTitle}</a>, <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0</a>`;

                    } else {

                        newCaption.innerHTML = existingCaption;
                    }

                    figure.appendChild(newCaption);
                }

            });
            $('status').style.display = 'none';
            output.value = doc.documentElement.querySelector('body').innerHTML;
            output.style.display = 'block';
            $('copyBtn').style.display = 'block';
        });

        $('htmlContent').addEventListener('click', () => {
            $('htmlContent').select();
        });

        $('openstax-url').addEventListener('click', () => {
            $('openstax-url').select();
        });

        $('sample-image-url').addEventListener('click', () => {
            $('sample-image-url').select();
        });

        $('copyBtn').addEventListener('click', () => {
            const output = $('output');
            output.select();
            document.execCommand('copy');
            alert('Output copied to clipboard!');
        });
    </script>
    <script>
        // track visits
        (async function () {
            try{
                const params = new URLSearchParams({
                  appId: window.location.pathname.split('/').filter(Boolean)[0] || 'unknown',
                  t: Date.now()
                });
                await fetch(`https://apphub-analytics-server-production.up.railway.app/track.gif?${params.toString()}`); 
            } catch(err) {
                console.error(err);
            }
        })();
    </script>
</body>

</html>